<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Latin Vocab!</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Don't use this in production: -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      /** Main component */
      const Main = (props) => {
        // state
        const [showFlashcard, setShowFlashcard] = React.useState(true);
        const [showVocabList, setShowVocabList] = React.useState(false);
        const [fields, setFields] = React.useState([]); // data field names
        const [vocab, setVocab] = React.useState([]); // data items
        const [sortField, setSortField] = React.useState(""); // field to sort on
        const [sortDirection, setSortDirection] = React.useState("ASC"); // ASC or DSC
        const [selectedIndices, setSelectedIndices] = React.useState([]); // array of data item indices
        const [currentSelectedIndex, setCurrentSelectedIndex] =
          React.useState(0); // current index into selected indices
        const [fieldFilters, setFieldFilters] = React.useState(undefined);

        // load Latin vocab CSV file at startup
        React.useEffect(() => {
          const url = "./Latin Vocabulary - Vocab.csv";
          fetch(url)
            .then(function (response) {
              console.log(url + " -> " + response.ok);
              if (response.ok) {
                return response.text();
              }
              throw new Error("Error message.");
            })
            .then(
              function (data) {
                // parse CSV file
                const results = Papa.parse(data, { header: true }); // object with { data, errors, meta }
                console.log(results);
                setVocab(results.data);
                setFields(results.meta.fields);
                setSortField(results.meta.fields[0]);
                setFieldFilters(Array(results.meta.fields.length).fill(""));
              }.bind(this)
            )
            .catch(function (err) {
              console.log("failed to load ", url, err.message);
            });
        }, []);

        // set selected indices (apply sorting and filtering)
        React.useEffect(() => {
          const indices = vocab.map((item, index) => index);
          const sortedIndices = !sortField
            ? indices // no sort if sort field is not set
            : indices.sort((indexA, indexB) => {
                const stringA = normalizeString(vocab[indexA][sortField]);
                const stringB = normalizeString(vocab[indexB][sortField]);
                const valueA = hasOnlyDigits(stringA)
                  ? parseInt(stringA)
                  : stringA;
                const valueB = hasOnlyDigits(stringB)
                  ? parseInt(stringB)
                  : stringB;
                if (valueA < valueB) return sortDirection === "ASC" ? -1 : 1;
                if (valueA > valueB) return sortDirection === "ASC" ? 1 : -1;
                return 0;
              });
          const filteredIndices =
            activeFieldFilterCount(fieldFilters) <= 0
              ? sortedIndices
              : sortedIndices.filter((selectedIndex) => {
                  const item = vocab[selectedIndex];
                  return filterItem(item, fields, fieldFilters);
                });

          setCurrentSelectedIndex(0);
          setSelectedIndices(filteredIndices);
        }, [vocab.length, sortField, sortDirection, fieldFilters]);

        // render page content!
        return (
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              justifyContent: "center",
            }}
          >
            {/* FlashCard Section */}
            <div>
              <button onClick={() => setShowFlashcard(!showFlashcard)}>
                {(showFlashcard ? "Hide" : "Show") + " Flashcard"}
              </button>
              {!!showFlashcard && (
                <FlashCard
                  item={vocab[selectedIndices[currentSelectedIndex]]}
                  previousDisabled={currentSelectedIndex <= 0}
                  onPressPrevious={() => {
                    if (currentSelectedIndex > 0) {
                      setCurrentSelectedIndex(currentSelectedIndex - 1);
                    }
                  }}
                  nextDisabled={
                    currentSelectedIndex >= selectedIndices.length - 1
                  }
                  onPressNext={() => {
                    if (currentSelectedIndex < selectedIndices.length - 1) {
                      setCurrentSelectedIndex(currentSelectedIndex + 1);
                    }
                  }}
                />
              )}
            </div>

            {/* VocabList Section */}
            <div>
              <button
                onClick={() => setShowVocabList(!showVocabList)}
                style={{ marginBottom: 10 }}
              >
                {(showVocabList ? "Hide" : "Show") + " Vocab List"}
              </button>
              {!!showVocabList && (
                <VocabList
                  fields={fields}
                  vocab={vocab}
                  selectedIndices={selectedIndices}
                  currentSelectedIndex={currentSelectedIndex}
                  sortField={sortField}
                  setSortField={setSortField}
                  sortDirection={sortDirection}
                  setSortDirection={setSortDirection}
                  fieldFilters={fieldFilters}
                  setFieldFilters={setFieldFilters}
                />
              )}
            </div>
          </div>
        );
      };

      /**
       * FlashCard component
       */
      const FlashCard = (props) => {
        // props
        const {
          item,
          previousDisabled,
          onPressPrevious,
          nextDisabled,
          onPressNext,
        } = props;

        // state
        const [showEnglish, setShowEnglish] = React.useState(false);

        // render
        return (
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              justifyContent: "center",
              alignItems: "center",
            }}
          >
            <Card item={item} showDetails={showEnglish} />
            <div>
              <Button disabled={previousDisabled} onClick={onPressPrevious}>
                Previous
              </Button>
              <Button
                style={{ backgroundColor: "yellow" }}
                onClick={() => {
                  setShowEnglish(!showEnglish);
                }}
              >
                {showEnglish ? "Hide" : "Show"}
              </Button>
              <Button disabled={nextDisabled} onClick={onPressNext}>
                Next
              </Button>
            </div>
          </div>
        );
      };

      /**
       * VocabList component
       */
      const VocabList = (props) => {
        // props
        const {
          fields,
          vocab,
          selectedIndices,
          currentSelectedIndex,
          sortField,
          setSortField,
          sortDirection,
          setSortDirection,
          fieldFilters,
          setFieldFilters,
        } = props;

        // cell styles
        const cellStyles = {
          rowFilter: {
            flex: 1,
            minWidth: 5,
            marginRight: 5,
          },
          rowHeader: {
            flex: 1,
            cursor: "pointer",
            color: "blue",
            textDecoration: "underline",
          },
          rowItem: {
            flex: 1,
          },
          selectedSort: {
            fontWeight: "bold",
          },
          English: {
            flex: 2,
          },
          Latin: {
            flex: 2,
          },
        };

        // render
        return (
          <div style={{ display: "flex", flexDirection: "column" }}>
            {/* Filter Row */}
            <div
              style={{
                display: "flex",
                flexDirection: "row",
              }}
            >
              {fields.map((fieldName, fieldIndex) => {
                return (
                  <input
                    key={fieldIndex}
                    style={{
                      ...cellStyles.rowFilter,
                      ...cellStyles[fieldName],
                    }}
                    type="text"
                    value={fieldFilters[fieldIndex]}
                    onChange={(event) =>
                      setFieldFilters(
                        Object.assign([], fieldFilters, {
                          [fieldIndex]: event.target.value,
                        })
                      )
                    }
                  />
                );
              })}
            </div>

            {/* Header Row */}
            <div
              style={{
                display: "flex",
                flexDirection: "row",
              }}
            >
              {fields.map((fieldName, fieldIndex) => {
                const isSortField = fieldName === sortField;
                const sortDisplayArrow = !isSortField
                  ? "" // this is not the sort field
                  : sortDirection === "ASC"
                  ? "↓"
                  : "↑";
                return (
                  <div
                    key={fieldIndex}
                    style={{
                      ...cellStyles.rowHeader,
                      ...cellStyles[fieldName],
                      ...(isSortField ? cellStyles.selectedSort : {}),
                    }}
                    onClick={() => {
                      if (!isSortField) {
                        setSortField(fieldName);
                        setSortDirection("ASC");
                      } else if (sortDirection === "ASC") {
                        setSortDirection("DSC");
                      } else {
                        setSortDirection("ASC");
                      }
                    }}
                  >
                    {fieldName + sortDisplayArrow}
                  </div>
                );
              })}
            </div>

            {/* Item Rows */}
            {selectedIndices.map((selectedIndex, displayIndex) => {
              const item = vocab[selectedIndex];
              return (
                <div
                  key={displayIndex}
                  style={{
                    display: "flex",
                    flexDirection: "row",
                    backgroundColor:
                      displayIndex % 2 == 0 ? "white" : "AliceBlue",
                    fontWeight:
                      displayIndex === currentSelectedIndex ? "bold" : "normal",
                  }}
                >
                  {fields.map((fieldName, fieldIndex) => (
                    <div
                      key={fieldIndex}
                      style={{
                        ...cellStyles.rowItem,
                        ...cellStyles[fieldName],
                      }}
                    >
                      {item[fieldName]}
                    </div>
                  ))}
                </div>
              );
            })}
          </div>
        );
      };

      /**
       * Button component
       */
      const Button = (props) => {
        return (
          <button
            {...props}
            style={{
              ...props.style,
              margin: 10,
              padding: 10,
              fontSize: 20,
            }}
          >
            {props.children}
          </button>
        );
      };

      /**
       * Card component
       */
      const Card = (props) => {
        const { item, showDetails = false } = props;
        const h2Style = {
          fontStyle: "italic",
          fontWeight: "normal",
        };
        if (!item) {
          return null;
        }
        return (
          <div
            style={{
              textAlign: "center",
              minHeight: 400,
            }}
          >
            <h1 style={{ fontSize: 50 }}>{item.Latin}</h1>
            {showDetails && (
              <div>
                <h2 style={h2Style}>{item.English}</h2>
                <h2 style={h2Style}>
                  {item["Part of Speech, Declension, Gender, etc."]}
                </h2>
                <h2 style={h2Style}>{item.Special}</h2>
                <h2 style={h2Style}>{"Page: " + item["Page Number"]}</h2>
              </div>
            )}
          </div>
        );
      };

      /**
       * Utility
       * -----------------------------------------------------------------------
       */

      /** Normalize a string by removing all accent chars and converting to lowercase */
      function normalizeString(rawStringValue) {
        return rawStringValue
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase();
      }

      /** Check if the given string has only digit characters */
      function hasOnlyDigits(value) {
        return /^\d+$/.test(value);
      }

      /** Return the number of active field filters */
      function activeFieldFilterCount(fieldFilters) {
        if (!fieldFilters) {
          return 0;
        }
        return fieldFilters.reduce((counter, currentValue) => {
          if (!!currentValue) {
            return counter + 1;
          }
          return counter;
        }, 0);
      }

      /** Return true if the item is included; false if the item is filtered out */
      function filterItem(item, fields, fieldFilters) {
        for (let xa = 0; xa < fields.length; ++xa) {
          const filterValue = fieldFilters[xa];
          if (!filterValue) {
            continue;
          }
          const fieldName = fields[xa];
          const normalizedFieldValue = normalizeString(item[fieldName]);
          if (normalizedFieldValue.includes(filterValue.toLowerCase())) {
            return true;
          }
        }
        return false;
      }

      /**
       * Main Render!
       * -----------------------------------------------------------------------
       */
      ReactDOM.render(<Main />, document.getElementById("root"));
    </script>
  </body>
</html>
